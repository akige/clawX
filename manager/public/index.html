<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clawX ç®¡ç†é¢æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #444; }
        .btn { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-green { background: #34c759; }
        .btn-green:hover { background: #248a3d; }
        .btn-red { background: #ff3b30; }
        .btn-red:hover { background: #d63027; }
        .btn-orange { background: #ff9500; }
        .btn-orange:hover { background: #e08600; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .config-item:last-child { border-bottom: none; }
        .config-info { flex: 1; }
        .config-name { font-weight: 600; color: #333; }
        .config-desc { font-size: 12px; color: #666; margin-top: 4px; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-unknown { background: #fff3cd; color: #856404; }
        .backup-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .backup-date { font-family: monospace; color: #333; }
        .backup-actions { display: flex; gap: 8px; }
        .log { background: #1e1e1e; color: #ddd; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .refresh-btn { background: #8e8e93; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ clawX ç®¡ç†é¢æ¿</h1>
            <button class="btn refresh-btn" onclick="loadAll()">ğŸ”„ åˆ·æ–°</button>
        </div>

        <!-- Gateway çŠ¶æ€ -->
        <div class="card">
            <h2>ğŸ“¡ Gateway çŠ¶æ€</h2>
            <div id="gateway-status">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-orange" onclick="restartGateway()">ğŸ”„ é‡å¯ Gateway</button>
            </div>
        </div>

        <!-- é…ç½®æ£€æŸ¥ -->
        <div class="card">
            <h2>âš™ï¸ é…ç½®çŠ¶æ€</h2>
            <div id="config-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-green" onclick="checkConfigs()">âœ… æ£€æŸ¥é…ç½®</button>
            </div>
        </div>

        <!-- å¤‡ä»½ç®¡ç† -->
        <div class="card">
            <h2>ğŸ’¾ å¤‡ä»½ç®¡ç†</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="createBackup()">â• åˆ›å»ºå¤‡ä»½</button>
            </div>
            <div id="backup-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="card">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div class="log" id="log">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let backups = [];

        function log(msg) {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.textContent = `[${time}] ${msg}\n` + el.textContent;
        }

        function setStatus(id, html) {
            document.getElementById(id).innerHTML = html;
        }

        async function loadAll() {
            await Promise.all([loadGatewayStatus(), loadConfigs(), loadBackups()]);
        }

        async function loadGatewayStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data.success) {
                    const running = data.status.includes('running');
                    setStatus('gateway-status', `<span class="status-badge ${running ? 'status-ok' : 'status-error'}">${running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</span><pre style="margin-top:10px;font-size:12px;background:#f5f5f5;padding:10px;border-radius:4px;">${data.status}</pre>`);
                } else {
                    setStatus('gateway-status', `<span class="status-badge status-unknown">${data.status}</span>`);
                }
            } catch (e) {
                setStatus('gateway-status', `<span class="status-badge status-error">åŠ è½½å¤±è´¥</span>`);
            }
        }

        async function loadConfigs() {
            try {
                const res = await fetch('/api/configs');
                const data = await res.json();
                if (data.success) {
                    let html = '';
                    for (let c of data.configs) {
                        html += `<div class="config-item">
                            <div class="config-info">
                                <div class="config-name">${c.name}</div>
                                <div class="config-desc">${c.desc}</div>
                            </div>
                            <span class="status-badge ${c.exists ? 'status-ok' : 'status-error'}">${c.exists ? 'âœ“ å­˜åœ¨' : 'âœ— ä¸å­˜åœ¨'}</span>
                        </div>`;
                    }
                    setStatus('config-list', html);
                }
            } catch (e) {
                setStatus('config-list', '<div class="loading">åŠ è½½å¤±è´¥</div>');
            }
        }

        async function loadBackups() {
            try {
                const res = await fetch('/api/backups');
                const data = await res.json();
                if (data.success) {
                    backups = data.backups;
                    if (backups.length === 0) {
                        setStatus('backup-list', '<div class="loading">æš‚æ— å¤‡ä»½</div>');
                    } else {
                        let html = '';
                        for (let b of backups) {
                            const date = b.date.slice(0,8).replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                            const time = b.date.slice(8,12).replace(/(\d{2})(\d{2})/, '$1:$2');
                            html += `<div class="backup-item">
                                <span class="backup-date">${date} ${time}</span>
                                <div class="backup-actions">
                                    <button class="btn" onclick="restoreBackup('${b.id}')">æ¢å¤</button>
                                </div>
                            </div>`;
                        }
                        setStatus('backup-list', html);
                    }
                }
            } catch (e) {
                setStatus('backup-list', '<div class="loading">åŠ è½½å¤±è´¥</div>');
            }
        }

        async function checkConfigs() {
            log('æ£€æŸ¥é…ç½®ä¸­...');
            try {
                const res = await fetch('/api/check', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    for (let r of data.results) {
                        log(`[${r.id}] ${r.message}`);
                    }
                }
                await loadConfigs();
            } catch (e) {
                log('æ£€æŸ¥å¤±è´¥: ' + e.message);
            }
        }

        async function createBackup() {
            log('åˆ›å»ºå¤‡ä»½ä¸­...');
            try {
                const res = await fetch('/api/backup', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log('å¤‡ä»½æˆåŠŸ: ' + data.id);
                    await loadBackups();
                } else {
                    log('å¤‡ä»½å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                log('å¤‡ä»½å¤±è´¥: ' + e.message);
            }
        }

        async function restoreBackup(id) {
            if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªå¤‡ä»½å—ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚')) return;
            log('æ¢å¤å¤‡ä»½ä¸­: ' + id);
            try {
                const res = await fetch('/api/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backupId: id })
                });
                const data = await res.json();
                if (data.success) {
                    log('æ¢å¤æˆåŠŸ: ' + data.message);
                } else {
                    log('æ¢å¤å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                log('æ¢å¤å¤±è´¥: ' + e.message);
            }
        }

        async function restartGateway() {
            log('é‡å¯ Gateway...');
            try {
                const res = await fetch('/api/restart', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    log(data.message);
                    setTimeout(loadGatewayStatus, 2000);
                } else {
                    log('é‡å¯å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                log('é‡å¯å¤±è´¥: ' + e.message);
            }
        }

        // åˆå§‹åŒ–
        loadAll();
    </script>
</body>
</html>
